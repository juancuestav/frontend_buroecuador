var E=Object.defineProperty;var A=(c,s,i)=>s in c?E(c,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[s]=i;var o=(c,s,i)=>(A(c,typeof s!="symbol"?s+"":s,i),i);import{c as y,i as h,n as u,d as p}from"./utils.c7760b0c.js";import{u as L}from"./notificaciones.fe24470b.js";import{_ as f,r as l,$ as v,c as b,b8 as w,G as k,a7 as x}from"./index.6072a1b1.js";import{S as C}from"./StatusEssentialLoading.d6258813.js";class V{constructor(s,i,e,t){o(this,"refs");o(this,"entidad");o(this,"entidad_vacia");o(this,"entidad_copia");o(this,"notificaciones",L());o(this,"argsDefault");o(this,"controller");o(this,"controllerFiles");o(this,"validaciones",[]);this.controller=i,this.controllerFiles=t,this.refs=e,this.entidad=f(new s),this.entidad_vacia=f(new s),this.entidad_copia=f(new s)}async ejecutarValidaciones(){try{for(const s of this.validaciones)if(!await s.validar())return}catch(s){return s instanceof Error&&this.notificaciones.notificarAdvertencia(s.message),!1}return!0}agregarValidaciones(...s){this.validaciones.push(...s)}limpiarValidaciones(){this.validaciones.splice(1,this.validaciones.length-1)}indexElementoEnLista(s){return this.refs.listado.value.findIndex(i=>i.id===s)}indexElementoEnListaArchivos(s){return this.refs.listadoArchivos.value.findIndex(i=>i.id===s)}agregarElementoListadoActual(s,i=!0){i?this.refs.listado.value=[s,...this.refs.listado.value]:this.refs.listado.value=[...this.refs.listado.value,s]}agregarElementosListadoActual(s,i=!0){i?this.refs.listado.value=[...s,...this.refs.listado.value]:this.refs.listado.value=[...this.refs.listado.value,...s]}agregarElementoListadoArchivosActual(s){this.refs.listadoArchivos.value=[s,...this.refs.listadoArchivos.value]}eliminarElementoListaActual(s){const i=this.indexElementoEnLista(s.id);i>=0&&(this.refs.listado.value.splice(i,1),this.refs.listado.value=[...this.refs.listado.value])}eliminarElementoListaArchivosActual(s){const i=this.indexElementoEnListaArchivos(s.id);i>=0&&(this.refs.listadoArchivos.value.splice(i,1),this.refs.listado.value=[...this.refs.listado.value])}actualizarElementoListadoActual(s){const i=this.indexElementoEnLista(s.id);i>=0&&(this.refs.listado.value.splice(i,1,s),this.refs.listado.value=[...this.refs.listado.value])}async obtenerListados(s){const i=[],e={};let t=0,a,r;for(const d in s){e[t++]=d;const n=s[d];n.controller&&n.params?(a=n.controller,r=n.params):Array.isArray(n)?(a=null,r={}):(a=s[d],r={}),a?i.push(a.listar({...this.argsDefault,...r})):i.push(new Promise(g=>g(n))),this.refs.listadosAuxiliares[d]=[]}return Promise.allSettled(i).then(d=>{d.forEach((n,g)=>{if(n.status==="fulfilled"){const m=e[g];Array.isArray(n.value)&&this.refs.listadosAuxiliares[m].push(...n.value),Array.isArray(n.value.result)&&this.refs.listadosAuxiliares[m].push(...n.value.result)}})})}seCambioEntidad(s){return y(s,this.entidad)}getController(){return this.controller}}class j{bindHook(s,i){this[s]=i}}class B extends j{constructor(){super();o(this,"onBeforeGuardar");o(this,"onGuardado");o(this,"onBeforeModificar");o(this,"onModificado");o(this,"onBeforeConsultar");o(this,"onConsultado");o(this,"onReestablecer");o(this,"onListado");o(this,"onListadosCargados");this.onBeforeGuardar=()=>{},this.onGuardado=()=>{},this.onBeforeModificar=()=>{},this.onModificado=()=>{},this.onBeforeConsultar=()=>{},this.onConsultado=()=>{},this.onReestablecer=()=>{},this.onListado=()=>{},this.onListadosCargados=()=>{}}}class F extends B{constructor(){super()}}class P{constructor(){o(this,"tabs");o(this,"validador");o(this,"filtros");o(this,"listadoActividades");o(this,"listadoArchivos");o(this,"listado");o(this,"currentPageListado");o(this,"nextPageUrl");o(this,"accion");o(this,"disabled");o(this,"listadosAuxiliares");o(this,"errors");o(this,"metaPagination");o(this,"pagination",l({sortBy:"desc",descending:!1,page:1,rowsPerPage:3,rowsNumber:10,last_page:2,total:0}));this.errors=l(),this.tabs=l(),this.validador=l(),this.listadosAuxiliares=f({}),this.filtros=f({search:null,fields:null}),this.listado=l([]),this.listadoArchivos=l([]),this.listadoActividades=l([]),this.currentPageListado=l(1),this.nextPageUrl=l(),this.accion=l(v.nuevo),this.metaPagination=l(),this.disabled=b(()=>[v.eliminar,v.consultar].includes(this.accion.value))}}class D extends V{constructor(i,e,t){super(i,e,w(new P),t);o(this,"hooks",new F);o(this,"statusEssentialLoading",new C)}async cargarVista(i){try{this.statusEssentialLoading.activar(),await i()}catch(e){throw e}finally{this.statusEssentialLoading.desactivar()}}useReferencias(){return{entidad:this.entidad,...this.refs}}useComportamiento(){return{listar:this.listar.bind(this),listarArchivos:this.listarArchivos.bind(this),filtrar:this.filtrar.bind(this),consultar:this.consultar.bind(this),guardarArchivos:this.guardarArchivos.bind(this),guardar:this.guardar.bind(this),editar:this.editar.bind(this),editarParcial:this.editarParcial.bind(this),eliminar:this.eliminar.bind(this),eliminarArchivo:this.eliminarArchivo.bind(this),reestablecer:this.reestablecer.bind(this),obtenerListados:this.obtenerListados.bind(this),cargarVista:this.cargarVista.bind(this),setValidador:this.setValidador.bind(this),guardarFormData:this.guardarFormData.bind(this)}}useHooks(){return{onBeforeGuardar:i=>this.hooks.bindHook("onBeforeGuardar",i),onGuardado:i=>this.hooks.bindHook("onGuardado",i),onBeforeConsultar:i=>this.hooks.bindHook("onBeforeConsultar",i),onConsultado:i=>this.hooks.bindHook("onConsultado",i),onBeforeModificar:i=>this.hooks.bindHook("onBeforeModificar",i),onModificado:i=>this.hooks.bindHook("onModificado",i),onReestablecer:i=>this.hooks.bindHook("onReestablecer",i),onListado:i=>this.hooks.bindHook("onListado",i),onListadosCargados:i=>this.hooks.bindHook("onListadosCargados",i)}}async consultar(i,e){if(this.hooks.onBeforeConsultar(),i.id===null)return this.notificaciones.notificarAdvertencia("No se puede consultar el recurso con id null");const t=i.id;try{this.cargarVista(async()=>{const{result:a}=await this.controller.consultar(t,{...this.argsDefault,...e});this.entidad.hydrate(a),this.entidad_copia.hydrate(JSON.parse(JSON.stringify(this.entidad))),this.refs.tabs.value="formulario",this.hooks.onConsultado(a)})}catch(a){if(h(a)){const r=a.erroresValidacion;await u(r,this.notificaciones)}}finally{}}async listar(i,e=!1){this.statusEssentialLoading.activar();try{const{result:t,meta:a,response:r}=await this.controller.listar(i);if(i!=null&&i.hasOwnProperty("export"))return p(r.data,i.titulo,i.export);t.length==0&&this.notificaciones.notificarInformacion("A\xFAn no se han agregado elementos."),e?this.refs.listado.value.push(...t):this.refs.listado.value=t,this.refs.pagination.value.last_page=a==null?void 0:a.last_page,this.refs.pagination.value.page=a==null?void 0:a.current_page,this.refs.pagination.value.total=a==null?void 0:a.total}catch(t){if(h(t)){const a=t.erroresValidacion;console.log(a),await u(a,this.notificaciones)}this.notificaciones.notificarError(t+"")}finally{this.statusEssentialLoading.desactivar()}this.hooks.onListado()}async filtrar(i){this.cargarVista(async()=>{try{const{result:e}=await this.controller.filtrar(i);e.length==0&&this.notificaciones.notificarInformacion("No se encontraron coincidencias."),this.refs.listado.value=e,this.notificaciones.notificarInformacion("Resultados encontrados.")}catch(e){this.notificaciones.notificarError(e)}})}async reestablecer(){var i;this.entidad.hydrate(this.entidad_vacia),this.refs.accion.value=v.nuevo,(i=this.refs.validador.value)==null||i.$reset(),this.hooks.onReestablecer()}async guardar(i,e=!0,t){if(this.statusEssentialLoading.activar(),!this.seCambioEntidad(this.entidad_vacia))throw this.notificaciones.notificarAdvertencia("No se ha efectuado ningun cambio"),this.statusEssentialLoading.desactivar(),new Error("No se ha efectuado ningun cambio");if(this.refs.validador.value&&!await this.refs.validador.value.$validate()||!await this.ejecutarValidaciones())throw this.notificaciones.notificarAdvertencia("Verifique el formulario"),this.statusEssentialLoading.desactivar(),new Error("Verifique el formulario");this.hooks.onBeforeGuardar();try{const{response:a}=await this.controller.guardar(i,{...t,...this.argsDefault});this.notificaciones.notificarCorrecto(a.data.mensaje),a.data.modelo&&(Array.isArray(a.data.modelo)?this.agregarElementosListadoActual(a.data.modelo,e):(this.agregarElementoListadoActual(a.data.modelo,e),this.entidad.hydrate(a.data.modelo)));const r=JSON.parse(JSON.stringify(this.entidad));return this.hooks.onGuardado(r.id,a.data),this.reestablecer(),r}catch(a){if(h(a)){const r=a.erroresValidacion;await u(r,this.notificaciones)}throw a}finally{this.statusEssentialLoading.desactivar()}}async eliminarArchivo(i,e){this.notificaciones.confirmar("\xBFEst\xE1 seguro que desea eliminar?",()=>{if(i.id===null)return this.notificaciones.notificarAdvertencia("No se puede eliminar el recurso con id null");if(!this.controllerFiles)return this.notificaciones.notificarError("El mixin requiere de una instancia de ArchivoController()");this.controllerFiles.eliminarFile(i.id).then(({response:t})=>{this.notificaciones.notificarCorrecto(t.data.mensaje),this.eliminarElementoListaArchivosActual(i),e&&e()}).catch(t=>{if(h(t)){const a=t.erroresValidacion;u(a,this.notificaciones)}else this.notificaciones.notificarError(t.mensaje)})})}async listarArchivos(i,e,t=!1){this.statusEssentialLoading.activar();try{const{result:a}=await this.controller.listarFiles(i,e);a.length==0&&this.notificaciones.notificarInformacion("A\xFAn no se han agregado elementos"),t&&this.refs.listadoArchivos.value.push(...a),this.refs.listadoArchivos.value=a}catch(a){this.notificaciones.notificarError(a)}this.statusEssentialLoading.desactivar()}async guardarArchivos(i,e){this.statusEssentialLoading.activar();try{const{response:t}=await this.controller.guardarFiles(i,e);return this.notificaciones.notificarCorrecto(t.data.mensaje),t}catch(t){if(h(t)){const a=t.erroresValidacion;await u(a,this.notificaciones)}}finally{this.statusEssentialLoading.desactivar()}}async editar(i,e=!0,t){if(console.log("editar..."),this.statusEssentialLoading.activar(),this.entidad.id===null)return this.statusEssentialLoading.desactivar(),this.notificaciones.notificarAdvertencia("No se puede editar el recurso con id null");if(!this.seCambioEntidad(this.entidad_copia))return this.statusEssentialLoading.desactivar(),this.notificaciones.notificarAdvertencia("No se ha efectuado ningun cambio");if(this.hooks.onBeforeModificar(),this.refs.validador.value&&!await this.refs.validador.value.$validate()||!await this.ejecutarValidaciones())throw this.notificaciones.notificarAdvertencia("Verifique el formulario"),this.statusEssentialLoading.desactivar(),new Error("Verifique el formulario");this.cargarVista(async()=>{var a;try{const{response:r,result:d}=await this.controller.editar(i,{...t,...this.argsDefault});this.notificaciones.notificarCorrecto(r.data.mensaje),this.actualizarElementoListadoActual(d),this.entidad.hydrate(r.data.modelo),e&&this.reestablecer();const n=(a=r.data.modelo.id)!=null?a:0;this.hooks.onModificado(n,r.data)}catch(r){if(h(r)){const d=r.erroresValidacion;u(d,this.notificaciones)}else this.notificaciones.notificarError(r.message)}})}async editarParcial(i,e,t){return this.hooks.onBeforeModificar(),this.cargarVista(async()=>{try{const{response:a,result:r}=await this.controller.editarParcial(i,e,{...t,...this.argsDefault});this.notificaciones.notificarCorrecto(a.data.mensaje),this.actualizarElementoListadoActual(r),this.entidad.hydrate(a.data.modelo),this.reestablecer(),this.hooks.onModificado(i,a.data)}catch(a){if(h(a)){const r=a.erroresValidacion;u(r,this.notificaciones)}else this.notificaciones.notificarError(a.message);throw a}})}async eliminar(i,e){this.notificaciones.confirmar("\xBFEsta seguro que desea eliminar?",()=>{if(i.id===null)return this.notificaciones.notificarAdvertencia("No se puede eliminar el recurso con id null");this.controller.eliminar(i.id).then(({response:t})=>{this.notificaciones.notificarCorrecto(t.data.mensaje),this.eliminarElementoListaActual(i),this.reestablecer(),e&&e()}).catch(t=>{if(h(t)){const a=t.erroresValidacion;u(a,this.notificaciones)}else this.notificaciones.notificarError(t.message)})})}setValidador(i){this.refs.validador.value=i}async verificarAutenticacion(){const e=await k().isUserLoggedIn(),t=x();e||t.replace({name:"Login"})}async guardarFormData(i){this.hooks.onBeforeGuardar(),this.cargarVista(async()=>{try{const{response:e}=await this.controller.guardarFormData(i,this.argsDefault);this.notificaciones.notificarCorrecto(e.data.mensaje),this.agregarElementoListadoActual(e.data.modelo),this.entidad.hydrate(e.data.modelo),this.hooks.onGuardado(),this.reestablecer()}catch(e){if(h(e)){const t=e.erroresValidacion;await u(t,this.notificaciones)}}})}}export{D as C};
